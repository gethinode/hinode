{{/* 
    Copyright Â© 2022 - 2025 The Hinode Team / Mark Dumay. All rights reserved.
    Use of this source code is governed by The MIT License (MIT) that can be found in the LICENSE file.
    Visit gethinode.com/license for more details.
*/}}

{{ $error := false }}

{{/* Initialize arguments */}}
{{ $args := partial "utilities/InitArgs.html" (dict "structure" "navbar-item" "args" . "group" "partial") }}
{{ if or $args.err $args.warnmsg }}
    {{ partial (cond $args.err "utilities/LogErr.html" "utilities/LogWarn.html") (dict 
        "partial" "assets/helpers/navbar-item.html" 
        "warnid"  "warn-invalid-arguments"
        "msg"     "Invalid arguments"
        "details" ($args.errmsg | append $args.warnmsg)
        "file"    page.File
    )}}
    {{ $error = true }}
{{ end }}

{{/* Initialize local arguments */}}
{{- $page := $args.page -}}
{{- $entry := or $args.menuEntry $args.menu -}}
{{- if not $entry }}
    {{ partial "utilities/LogErr.html" (dict 
        "partial" "assets/helpers/navbar-item.html" 
        "warnid"  "warn-invalid-arguments"
        "msg"     "Invalid arguments"
        "details" (slice "missing argument `menu-entry`")
        "file"    page.File
    )}}
    {{ $error = true }}
{{ end }}
{{- $cue := $args.cue | default site.Params.main.externalLinks.cue -}}
{{- $tab := $args.tab | default site.Params.main.externalLinks.tab -}}
{{- $baseURL := $page.Scratch.Get "baseURL" | default "/" -}}
{{- $menuURL := "" -}}
{{ if or (strings.HasPrefix $entry.PageRef "http") (strings.HasPrefix $entry.URL "http") }}
    {{ $menuURL = or $entry.PageRef $entry.URL }}
{{ else if (or $entry.PageRef $entry.URL) }}
    {{- $menuURL = partial "utilities/URLJoin.html" (dict "base" $baseURL "path" ((or $entry.PageRef $entry.URL) | relLangURL)) -}}
{{ end }}
{{- $pageURL := $page.RelPermalink -}}
{{- $isActive := or (and (eq $pageURL $menuURL) (ne $menuURL ("/" | relLangURL))) (eq $pageURL $menuURL) -}}
{{ if not $entry.PageRef }}{{ $isActive = false }}{{ end }}
{{- $isIcon := or $entry.Params.icon $entry.Pre -}}
{{- $isAlias := $entry.Params.alias -}}
{{- $isControl := $entry.Params.control -}}

{{- $url := urls.Parse $menuURL -}}
{{- $baseURL := urls.Parse $.Site.Params.Baseurl -}}
{{- $isExternal := ne $url.Host $baseURL.Host -}}
{{- $externalHref := "" }}
{{- $suffix := "" }}
{{- $anchorClass := "" -}}

{{- if $isExternal }}
    {{- if $tab }}{{ $externalHref = "target=\"_blank\" rel=\"noopener noreferrer nofollow\"" }}{{ end -}}
    {{- if $cue }}{{ $suffix = partial "assets/icon.html" (dict "icon" "fas up-right-from-square fa-2xs") }}{{ end -}}
{{ else if $menuURL }}
    {{ $ref := partial "utilities/GetPage.html" (dict "url" $url.Path "page" $page) }}
    {{- if not $ref -}}
        {{- warnf "partial [assets/helpers/navbar-item.html] - Cannot find page of menu item '%s': %s" $entry.Name $url -}}
    {{ end }}
{{ end -}}

{{- $mainNav := urlize (lower $entry.Name) -}}
{{- $childNav := "" -}}

{{- $button := "" -}}
{{- if $args.modal -}}
    {{- $button = printf " role=%q data-bs-toggle=%q data-bs-target=%q" "button" "modal" $args.modal -}}
{{- end -}}
{{- $menuParent := or $args.menuParent $args.parent  }}
{{- if $menuParent -}}
    {{- $mainNav = urlize (lower $menuParent.Name) -}}
    {{- $childNav = urlize (lower $entry.Name) -}}
    {{- $anchorClass = "dropdown-item" -}}
{{- else if and (not $args.plain) $entry.HasChildren -}}
    {{- $anchorClass = "nav-link dropdown-toggle" -}}
    {{- $button = " role=\"button\" data-bs-toggle=\"dropdown\" aria-expanded=\"false\"" -}}
{{- else -}}
    {{- $anchorClass = "nav-link" -}}
{{- end -}}
{{- $params := "" -}}
{{- if and $isAlias (not $isExternal) -}}
    {{- $params = printf "?menu=%s" $mainNav -}}
    {{- with $childNav }}{{ $params = printf "%s&child=%s" $params . }}{{ end -}}
{{- end -}}

{{/* Main code */}}
{{ if not $error }}
    {{ $title := $entry.Name }}
    {{ if and site.Params.main.titleCase (not $args.page.Params.exact) }}{{ $title = title $title }}{{ end }}

    {{ if $entry.Params.button }}
        {{ partial "assets/button.html" (dict 
            "title"       $title
            "icon"        $entry.Pre
            "href"        $menuURL
            "button-size" "sm"
        )}}
    {{ else }}
        {{ cond (ne $menuURL "") "<a" "<div" | safeHTML }} 
            class="{{ $anchorClass }}{{ if $isActive }} active{{ end }}{{ with $args.class }} {{ . }}{{ end }}" 
            {{ if $isIcon }}aria-label="{{ $title }}"{{ end }}
            data-nav="main" data-nav-main="{{ $mainNav }}"{{ with $childNav }} data-nav-child="{{ . }}"{{ end }} 
            {{ if $menuURL }} href="{{ $menuURL }}{{ $params | safeHTML }}"{{ with $externalHref }} {{ . | safeHTML }}{{ end }}{{ end }}
            {{ $button | safeHTML }}
            {{ with $args.id }}id="{{ . }}"{{ end }}
            >
            
            {{- with $entry.Pre }}
                {{ if hasPrefix . "<i" }}
                    {{ . | safeHTML }}
                {{ else }}
                    {{ partial "assets/icon.html" (dict "icon" (printf "%s fa-fw" .) "spacing" false )}}
                {{ end }}
            {{ end -}}
            <span class="{{ if $isActive }}active{{ end }} {{ with $args.breakpoint }}d-{{ . }}-none {{ end }}">
                {{- if and $isIcon $entry.Pre }}&nbsp;{{ end }}{{ $title }}
                {{- with $entry.Post }}{{ . }}{{ end -}}
                {{- with $suffix }}&nbsp;{{ . }}{{ end -}}
            </span>
            {{ if or (not $isIcon) (not $isControl) }}
            <span class="{{ if $isActive }}active{{ end }} {{ with $args.breakpoint }}d-none d-{{ . }}-block{{ end }}">
                {{- if and $isIcon $entry.Pre }}&nbsp;{{ end }}{{ $title }}
                {{- with $entry.Post }}{{ . }}{{ end -}}
                {{- with $suffix }}&nbsp;{{ . }}{{ end -}}
            </span>
            {{ end }}
        {{ cond (ne $menuURL "") "</a>" "</div>" | safeHTML }}
    {{ end }}
{{ end }}